<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern Chat Application</title>
    <script src="https://npmcdn.com/parse/dist/parse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .message {
        @apply p-3 rounded-lg max-w-[80%] shadow-sm mb-2;
      }
      .message.sent {
        @apply bg-blue-500 text-white self-end;
        border-bottom-right-radius: 0;
      }
      .message.received {
        @apply bg-white text-gray-800 self-start;
        border-bottom-left-radius: 0;
      }
      .message-username {
        @apply font-semibold text-xs mb-1 opacity-75;
      }
      .message-content {
        @apply text-sm;
      }
      .room-button {
        @apply w-full text-left p-4 mb-3 rounded-lg transition-all duration-200 ease-in-out flex items-center;
        @apply hover:bg-gray-100 hover:shadow-md;
      }
      .room-button.active {
        @apply bg-blue-100 text-blue-800 font-medium shadow-md;
      }
      .room-icon {
        @apply w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center text-blue-600 font-semibold mr-4 text-lg;
      }
      #chat-messages::-webkit-scrollbar {
        width: 6px;
      }
      #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      #chat-messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
      }
      #chat-messages::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
    </style>
  </head>
  <body class="font-sans h-screen flex flex-col bg-gray-50">
    <div id="user-management" class="bg-white p-6 text-center shadow-md">
      <div id="login-signup">
        <input
          type="text"
          id="phone_number"
          placeholder="Phone Number"
          class="p-3 mb-2 w-full md:w-auto rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <input
          type="password"
          id="password"
          placeholder="Password"
          class="p-3 mb-2 w-full md:w-auto rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          onclick="login()"
          class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200"
        >
          Log In
        </button>
      </div>
      <div id="logout" class="hidden">
        <span id="current-user" class="mr-2 font-medium"></span>
        <button
          onclick="logout()"
          class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors duration-200"
        >
          Log Out
        </button>
      </div>
    </div>

    <div
      id="main-container"
      class="hidden flex-1 flex overflow-hidden bg-white rounded-xl shadow-lg m-6"
    >
      <div id="rooms-screen" class="w-1/3 bg-gray-50 p-6 overflow-y-auto border-r">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Rooms</h2>
        <div id="public-rooms">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">Public Rooms</h3>
          <div id="room-list" class="mb-6"></div>
          <div class="flex space-x-2">
            <input
              type="text"
              id="room-input"
              placeholder="Enter room name"
              class="p-3 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button
              onclick="createRoom()"
              class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors duration-200"
            >
              Create
            </button>
          </div>
        </div>
        <div id="private-chat-section" class="mt-8">
          <h3 class="text-lg font-semibold mb-4 text-gray-700">Private Chats</h3>
          <div class="flex space-x-2">
            <input
              type="text"
              id="private-chat-user"
              placeholder="Enter username to chat with"
              class="p-3 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
            <button
              onclick="createPrivateRoom()"
              class="bg-purple-500 text-white p-3 rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors duration-200"
            >
              Chat
            </button>
          </div>
          <div id="private-rooms" class="mt-6"></div>
        </div>
      </div>
      <div id="chat-screen" class="w-2/3 flex flex-col p-8 bg-white rounded-2xl shadow-lg">
        <h2 id="current-room" class="text-3xl font-bold mb-8 text-gray-800 border-b pb-4">
          No room selected
        </h2>
        <div
          id="chat-messages"
          class="flex-1 overflow-y-auto rounded-2xl p-6 mb-8 flex flex-col bg-gray-100 space-y-4 shadow-inner"
        ></div>
        <div id="message-input-container" class="flex space-x-4">
          <input
            type="text"
            id="message-input"
            placeholder="Type your message..."
            class="flex-1 p-4 rounded-full border-none bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner"
          />
          <button
            onclick="sendMessage()"
            class="bg-blue-600 text-white p-4 rounded-full hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 shadow-md"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
          </button>
        </div>
        <input
          type="text"
          id="image-url-input"
          placeholder="Image URL (optional)"
          class="p-4 w-full rounded-full border-none bg-gray-100 mt-6 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner"
        />
        <div class="flex space-x-4 mt-6">
          <button
            id="record-button"
            onclick="startRecording()"
            class="flex-1 bg-yellow-500 text-white p-4 rounded-full hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-all duration-200 shadow-md"
          >
            Start Recording
          </button>
          <button
            id="stop-button"
            onclick="stopRecording()"
            disabled
            class="flex-1 bg-red-500 text-white p-4 rounded-full hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-all duration-200 shadow-md"
          >
            Stop Recording
          </button>
        </div>
      </div>
    </div>

    <script>
      // Initialize Parse
      Parse.initialize('myAppId'); // Replace with your App ID
      Parse.serverURL = 'http://localhost:1337/parse'; // Replace with your server URL

      let currentUser = null;
      let currentRoom = null;
      let mediaRecorder;
      let audioChunks = [];

      async function makeAuthenticatedRequest(functionName, params = {}) {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
          throw new Error('No access token found. Please log in.');
        }

        const response = await fetch(`${Parse.serverURL}/functions/${functionName}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Parse-Application-Id': 'myAppId', // Replace with your Parse App ID
            Authorization: `Bearer ${accessToken}`,
          },
          body: JSON.stringify(params),
        });

        if (!response.ok) {
          const error = new Error(`HTTP error! status: ${response.status}`);
          error.response = response;
          throw error;
        }

        const result = await response.json();
        return result.result;
      }

      async function login() {
        const phoneNumber = document.getElementById('phone_number').value;
        const password = document.getElementById('password').value;

        try {
          const response = await fetch('https://mimi-dev.evalley.io/api/v1/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              phone_number: phoneNumber,
              prefix: '855',
              password: password,
              method: 'phone',
              is_vendor: false,
            }),
          });

          const data = await response.json();

          if (data.status === 200) {
            localStorage.setItem('accessToken', data.data.meta.access_token);
            localStorage.setItem('userData', JSON.stringify(data.data.item));
            updateUserUI();
            setupLiveQuery();
          } else {
            alert('Login failed: ' + (data.error_message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error during login:', error);
          alert('Login failed. Please try again.');
        }
      }

      function logout() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('userData');
        currentUser = null;
        updateUserUI();
      }

      async function updateUserUI() {
        const accessToken = localStorage.getItem('accessToken');

        if (accessToken) {
          try {
            const response = await fetch('https://mimi-dev.evalley.io/api/v1/auth/profile', {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            });

            const data = await response.json();

            if (data.status === 200) {
              currentUser = data.data.item;
              document.getElementById('login-signup').style.display = 'none';
              document.getElementById('logout').style.display = 'block';
              document.getElementById('main-container').style.display = 'flex';
              document.getElementById('current-user').textContent =
                `Logged in as: ${currentUser.name}`;
              loadRooms();
              loadPrivateRooms();
            } else {
              logout();
            }
          } catch (error) {
            console.error('Error fetching user profile:', error);
            logout();
          }
        } else {
          document.getElementById('login-signup').style.display = 'block';
          document.getElementById('logout').style.display = 'none';
          document.getElementById('main-container').style.display = 'none';
          document.getElementById('current-user').textContent = '';
        }
      }

      async function createRoom() {
        const roomName = document.getElementById('room-input').value.trim();
        if (roomName) {
          try {
            const room = await makeAuthenticatedRequest('createPublicRoom', {
              name: roomName,
              createdBy: currentUser.name,
            });
            document.getElementById('room-input').value = '';
            loadRooms();
          } catch (error) {
            console.error('Error creating room:', error);
            alert('Failed to create room. Please try again.');
          }
        }
      }

      function createRoomButton(room) {
        const button = document.createElement('button');
        button.className = 'room-button';
        button.onclick = () => joinRoom(room);

        const icon = document.createElement('div');
        icon.className = 'room-icon';
        icon.textContent = room.name.charAt(0).toUpperCase();

        const name = document.createElement('span');
        name.textContent = room.name;

        button.appendChild(icon);
        button.appendChild(name);
        return button;
      }

      async function loadRooms() {
        try {
          const result = await makeAuthenticatedRequest('listRooms', { page: 1, limit: 10 });
          const roomList = document.getElementById('room-list');
          roomList.innerHTML = '';
          result.results.forEach(room => {
            roomList.appendChild(createRoomButton(room));
          });
        } catch (error) {
          console.error('Error loading rooms:', error);
        }
      }

      async function createPrivateRoom() {
        const otherUsername = document.getElementById('private-chat-user').value.trim();
        if (otherUsername && otherUsername !== currentUser.name) {
          try {
            const roomName = `Private: ${currentUser.name} & ${otherUsername}`;
            const room = await makeAuthenticatedRequest('createPrivateRoom', {
              otherUsername: otherUsername,
              roomName: roomName,
              currentUser: currentUser,
            });
            document.getElementById('private-chat-user').value = '';
            loadPrivateRooms();
          } catch (error) {
            console.error('Error creating private room:', error);
            alert('Error creating private room: ' + error.message);
          }
        } else {
          alert('Please enter a valid username.');
        }
      }

      async function loadPrivateRooms() {
        try {
          const privateRooms = await makeAuthenticatedRequest('listPrivateRooms', {
            userId: currentUser.id,
          });
          const privateRoomsDiv = document.getElementById('private-rooms');
          privateRoomsDiv.innerHTML = '';
          privateRooms.forEach(room => {
            privateRoomsDiv.appendChild(createRoomButton(room));
          });
        } catch (error) {
          console.error('Error loading private rooms:', error);
        }
      }

      function joinRoom(room) {
        currentRoom = room;
        document.getElementById('current-room').textContent = `Current Room: ${room.name}`;
        loadMessages(room.id);

        // Update active room styling
        document.querySelectorAll('.room-button').forEach(btn => btn.classList.remove('active'));
        event.target.closest('.room-button').classList.add('active');

        if (window.innerWidth <= 600) {
          document.getElementById('rooms-screen').style.display = 'none';
          document.getElementById('chat-screen').style.display = 'flex';
        }
      }

      async function loadMessages(roomId) {
        try {
          const result = await makeAuthenticatedRequest('fetchChatMessages', {
            roomId,
            page: 1,
            limit: 50,
          });
          const chatMessages = document.getElementById('chat-messages');
          chatMessages.innerHTML = '';
          result.results.forEach(displayMessage);
          chatMessages.scrollTop = chatMessages.scrollHeight;
          
        } catch (error) {
          console.error('Error loading messages:', error);
        }
      }

      function displayMessage(message) {
        const chatMessages = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        const isSent = message.username === currentUser.name;

        messageDiv.className = `flex ${isSent ? 'justify-end' : 'justify-start'} mb-2`;

        let messageContent = `
          <div class="${isSent ? 'items-end' : 'items-start'} flex flex-col">
            ${!isSent ? `<div class="text-xs text-gray-500 mb-1">${message.username}</div>` : ''}
            <div class="${isSent ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-800'} rounded-2xl px-3 py-2 max-w-xs sm:max-w-md break-words">
              <div class="text-sm">${message.text}</div>
        `;

        if (message.imageUrl) {
          messageContent += `<img src="${message.imageUrl}" class="mt-2 max-w-full h-auto rounded-lg" alt="Shared image">`;
        }

        if (message.audioUrl) {
          messageContent += `
            <audio controls class="mt-2 w-full">
              <source src="${message.audioUrl}" type="audio/wav">
              Your browser does not support the audio element.
            </audio>
          `;
        }

        messageContent += `
            </div>
          </div>
        `;

        messageDiv.innerHTML = messageContent;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function sendMessage() {
        if (!currentRoom) {
          alert('Please select a room first.');
          return;
        }
        const text = document.getElementById('message-input').value.trim();
        const imageUrl = document.getElementById('image-url-input').value.trim();

        if (text || imageUrl) {
          try {
            const message = await makeAuthenticatedRequest('createMessage', {
              roomId: currentRoom.id,
              text: text,
              imageUrl: imageUrl,
              userId: String(currentUser.id),
              username: currentUser.name,
            });
            document.getElementById('message-input').value = '';
            document.getElementById('image-url-input').value = '';
            displayMessage(message);
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
          } catch (error) {
            console.error('Error sending message:', error);
            if (error.response) {
              console.error('Response:', await error.response.text());
            }
            alert('Failed to send message. Please try again.');
          }
        } else {
          alert('Please enter a message or provide an image URL.');
        }
      }

      async function startRecording() {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.ondataavailable = function (event) {
          audioChunks.push(event.data);
        };

        document.getElementById('record-button').disabled = true;
        document.getElementById('stop-button').disabled = false;
      }

      async function stopRecording() {
        mediaRecorder.stop();
        document.getElementById('record-button').disabled = false;
        document.getElementById('stop-button').disabled = true;

        mediaRecorder.onstop = async function () {
          const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          audioChunks = [];
          const audioUrl = await uploadAudio(audioBlob);
          await sendVoiceMessage(audioUrl);
        };
      }

      async function uploadAudio(audioBlob) {
        const formData = new FormData();
        formData.append('file', audioBlob, 'voice_message.wav');

        const response = await fetch(`${Parse.serverURL}/files/voice_message.wav`, {
          method: 'POST',
          headers: {
            'X-Parse-Application-Id': 'myAppId',
            'X-Parse-REST-API-Key': 'YOUR_REST_API_KEY',
            Authorization: `Bearer ${localStorage.getItem('accessToken')}`,
          },
          body: formData,
        });

        if (!response.ok) {
          throw new Error('Failed to upload audio file');
        }

        const data = await response.json();
        return data.url;
      }

      async function sendVoiceMessage(audioUrl) {
        if (!currentRoom) {
          alert('Please select a room first.');
          return;
        }

        try {
          const message = await makeAuthenticatedRequest('createMessage', {
            roomId: currentRoom.id,
            text: '',
            imageUrl: '',
            audioUrl: audioUrl,
            userId: String(currentUser.id),
            username: currentUser.name,
          });
          displayMessage(message);
          const chatMessages = document.getElementById('chat-messages');
          chatMessages.scrollTop = chatMessages.scrollHeight;
        } catch (error) {
          console.error('Error sending voice message:', error);
          alert('Failed to send voice message. Please try again.');
        }
      }

      async function setupLiveQuery() {
        const accessToken = localStorage.getItem('accessToken');
        if (!accessToken) {
          console.error('No access token found. LiveQuery setup failed.');
          return;
        }

        const wsURL = 'ws://localhost:1337/parse'; // Replace with your WebSocket URL
        const client = new Parse.LiveQueryClient({
          applicationId: 'myAppId', // Replace with your Parse App ID
          serverURL: wsURL,
          javascriptKey: 'YOUR_JAVASCRIPT_KEY', // Add your Parse JavaScript Key
        });

        client.on('open', () => {
          console.log('LiveQuery connection established');
        });

        client.on('error', error => {
          console.error('LiveQuery error:', error);
        });

        client.open();

        const query = new Parse.Query('Message');
        const subscription = await client.subscribe(query, accessToken);

        subscription.on('create', message => {
          if (message.get('roomId') === currentRoom.id) {
            displayMessage({
              username: message.get('username'),
              text: message.get('text'),
              imageUrl: message.get('imageUrl'),
              audioUrl: message.get('audioUrl'),
            });
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        });
      }

      function showRooms() {
        document.getElementById('rooms-screen').style.display = 'block';
        document.getElementById('chat-screen').style.display = 'none';
      }

      window.addEventListener('resize', function () {
        if (window.innerWidth > 600) {
          document.getElementById('rooms-screen').style.display = 'block';
          document.getElementById('chat-screen').style.display = 'flex';
        }
      });

      // Initialize the application
      updateUserUI();
    </script>
  </body>
</html>
